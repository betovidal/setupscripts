#!/usr/bin/env bash

CONFS="$HOME/.config/nginx"
MNGINXCONF="$HOME/.config/nginx/nginx.conf"
MPHPCONF="${CONFS}/php-fpm.conf"
NGINX="/etc/nginx"
PHPCONF="${NGINX}/php-fpm.conf"
NGINXCONF="/etc/nginx/nginx.conf"
NGINXBK="/etc/nginx/nginx.conf.bckp"
AVAILABLE="${NGINX}/conf.d"
AVAILABLE_HTTP="${NGINX}/conf.d/http"
# ENABLED="${NGINX}/sites-enabled/"
HTTPTEMPLATE="${CONFS}/templates/http.conf"

print_help() {
    fname="ngcli"
    printf "Usage: %s [COMMAND] [ARGS]\n" "${fname}"
    echo "Commands:"
    echo "  i | init"
    echo "    Copy/symlink nginx configuration files from."
    echo "    ${CONFS} and into ${NGINX}."
    echo "  l | ls | list"
    echo "    List available virtual servers information."
    echo "  c | create SITE_NAME PORT_NUMBER"
    echo "    Create new virtual server with the given parameters."
    echo ""
    echo "Needed with sudo: init, create."
}

get_filename() {
    filename=$(basename -- "$1")
    echo "${filename%.*}"
}

init() {
    # Create directories
    if [ ! -d "${NGINX}/" ]; then
        echo "No directory $NGINX. Is nginx installed?"
        return
    fi
    # Make php-fpm.conf configuration availble
    if [ -f "${MPHPCONF}" ]; then
        sudo ln -sf "${MPHPCONF}" "${PHPCONF}"
        echo " ->[OK] Symlink of ${MPHPCONF} in ${PHPCONF} created."
    else
        echo " ->[ER] File ${MPHPCONF} does not exist. Skipping."
        return
    fi
    # Finally, make a backup of the original file and replace with mine.
    if [ ! -f "$NGINXBK" ]; then
        sudo cp "$NGINXCONF" "$NGINXBK"
        echo " ->[OK] Backed up $NGINXCONF to $NGINXBK"
    else
        echo " ->[WR] File $NGINXBK already exists. Skipping backup."
    fi
    if [ -f "${MNGINXCONF}" ]; then
        sudo rm "$NGINXCONF"
        sudo cp "$MNGINXCONF" "$NGINXCONF"
        echo " ->[OK] Copied $MNGINXCONF to $NGINXCONF."
    else
        echo " ->[ER] No file $NGINXCONF found."
        return
    fi
}

# TODO: Indicate available / enabled
list_servers() {
    if [ ! -d "$AVAILABLE_HTTP" ]; then
        echo " ->[ER] Directory $AVAILABLE_HTTP not found."
        return
    fi
    if [ -z "$(ls -A ${AVAILABLE_HTTP})" ]; then
        echo " ->[WR] Directory $AVAILABLE_HTTP is empty."
        return
    fi
    for conf in ${AVAILABLE_HTTP}/*; do
        contents=$(grep -m 3 'listen\|server_name\|root' "$conf")
        printf "%s\n%s\n\n" "$conf" "$contents"
    done
}

create_server() {
    [ -d "$AVAILABLE_HTTP" ] || sudo mkdir -p "$AVAILABLE_HTTP"
    if [ ! -f "$HTTPTEMPLATE" ]; then
        echo " ->[ER] No file $HTTPTEMPLATE found."
        return
    fi
    if [ -z "$1" ]; then
        echo " ->[ER] No site_name parameter given."
        return
    fi
    if [ -z "$2" ]; then
        echo " ->[ER] No port_number parameter given."
        return
    fi
    if [ -f "${AVAILABLE_HTTP}/$1" ]; then
        echo " ->[ER] Virtual server '$1' already exists."
        return
    fi
    tmpfile=$(mktemp)
    sed -e "s/{site_name}/$1/g" -e "s/{port_number}/$2/g" \
        "$HOME/.config/nginx/templates/http.conf" > "$tmpfile"
    sudo mv "$tmpfile" "${AVAILABLE_HTTP}/${1}.conf"
}

arg="$1"
case "$arg" in
    "init" | "i")
        init
        ;;
    "list" | "ls" | "l")
        list_servers
        ;;
    "create" | "c")
        # site_name="$2"
        # port_number="$3"
        create_server "$2" "$3"
        ;;
    *)
        echo "Unrecognized option '$arg'"
        print_help
esac
